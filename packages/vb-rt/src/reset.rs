use core::arch::naked_asm;

#[repr(C, align(4))]
struct ColumnTableContents([u16; 256]);

#[rustfmt::skip]
static COLUMN_TABLE_CONTENTS: ColumnTableContents = ColumnTableContents([
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00e0, 0x00bc,
    0x00a6, 0x0096, 0x008a, 0x0082, 0x007a, 0x0074, 0x006e, 0x006a,
    0x0066, 0x0062, 0x0060, 0x005c, 0x005a, 0x0058, 0x0056, 0x0054,
    0x0052, 0x0050, 0x0050, 0x004e, 0x004c, 0x004c, 0x004a, 0x004a,
    0x0048, 0x0048, 0x0046, 0x0046, 0x0046, 0x0044, 0x0044, 0x0044,
    0x0042, 0x0042, 0x0042, 0x0040, 0x0040, 0x0040, 0x0040, 0x0040,
    0x003e, 0x003e, 0x003e, 0x003e, 0x003e, 0x003e, 0x003e, 0x003c,
    0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c,
    0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c,
    0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c,
    0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c,
    0x003c, 0x003e, 0x003e, 0x003e, 0x003e, 0x003e, 0x003e, 0x003e,
    0x0040, 0x0040, 0x0040, 0x0040, 0x0040, 0x0042, 0x0042, 0x0042,
    0x0044, 0x0044, 0x0044, 0x0046, 0x0046, 0x0046, 0x0048, 0x0048,
    0x004a, 0x004a, 0x004c, 0x004c, 0x004e, 0x0050, 0x0050, 0x0052,
    0x0054, 0x0056, 0x0058, 0x005a, 0x005c, 0x0060, 0x0062, 0x0066,
    0x006a, 0x006e, 0x0074, 0x007a, 0x0082, 0x008a, 0x0096, 0x00a6,
    0x00bc, 0x00e0, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
    0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
]);

const LEFT_CTA: usize = 0x0003dc00;

#[unsafe(no_mangle)]
#[unsafe(naked)]
pub unsafe extern "C" fn _vb_rt_reset() {
    unsafe extern "Rust" {
        unsafe fn _vb_rt_main();
    }

    naked_asm!("
        movhi   hi(_data_lma), r0, r4
        movea   lo(_data_lma), r4, r4
        movhi   hi(_data_end), r0, r5
        movea   lo(_data_end), r5, r5
        movhi   hi(_data_start), r0, r6
        movea   lo(_data_start), r6, r6

    /* initialize data */
        jr  3f
    2:
        ld.b    0[r4], r7
        st.b    r7, 0[r6]
        add 1,r4
        add 1,r6
    3:
        cmp r5,r6
        blt 2b
    
    /* zero out the rest of RAM */
        movhi   0x0501, r0, r4
        jr  5f
    4:
        st.b    r0, 0[r5]
        add 1, r5
    5:
        cmp r4, r5
        blt 4b

    /* initialize the stack */
        movhi   hi(__gp), r0, sp
    /* and global reg */
        movea   lo(__gp), sp, gp

    /* init left column table */
        movhi   hi({COLUMN_TABLE_CONTENTS}), r0, r6
        movea   lo({COLUMN_TABLE_CONTENTS}), r6, r6
        movhi   hi({LEFT_CTA}), r0, r7
        movea   lo({LEFT_CTA}), r7, r7
        movea   0x0100, r0, r8
    6:
        ld.h    0[r6], r9
        st.h    r9, 0[r7]
        add 2, r6
        add 2, r7
        add -1, r8
        bnz 6b
    
    /* init right column table */
        movhi   hi({COLUMN_TABLE_CONTENTS}), r0, r6
        movea   lo({COLUMN_TABLE_CONTENTS}), r6, r6
        movea   0x0100, r0, r8
    7:
        ld.h    0[r6], r9
        st.h    r9, 0[r7]
        add 2, r6
        add 2, r7
        add -1, r8
        bnz 7b

    /* we're done, load up main */
        movhi   hi({main}), r0, r1
        movea   lo({main}), r1, r1
        jmp [r1]
    ",
    main = sym _vb_rt_main,
    COLUMN_TABLE_CONTENTS = sym COLUMN_TABLE_CONTENTS,
    LEFT_CTA = const LEFT_CTA)
}
